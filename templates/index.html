<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEUPROVAO</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <header class="top-nav">
        <div class="nav-inner">
            <div class="nav-left">
                <h1>MEUPROVAO<span class="dot">.</span></h1>
                <button class="nav-button" id="toggleCalculator">Minha Nota</button>
                <a href="{{ url_for('formulario_page') }}" class="nav-button">Enviar Nota</a>
            </div>
        </div>
    </header>

    <!-- Container principal -->
    <div class="main-container">

        <!-- Popup (Oculto por padrão) -->
        <div id="popup" class="popup">
            <div id="popupContent">
                <h2>Observação</h2>
                <p>As notas exibidas são baseadas nos dados disponíveis e podem não representar o corte exato para aprovação. No futuro, teremos dados mais completos.</p>
                <p>O site está no início do desenvolvimento!</p>
                <button id="closePopup">Entendi</button>
            </div>
        </div>

        <!-- Seção da Calculadora (expansão via max-height) -->
        <div class="containerCalculadora" id="calculatorContainer">
            <div class="calculadora">
                <div class="input-row">
                    <div class="input-group">
                        <label for="acertos">Acertos 2023:</label>
                        <input type="number" id="acertos" placeholder="Acertos 2023">
                    </div>
                    <div class="input-group">
                        <label for="acertos2">Acertos 2024:</label>
                        <input type="number" id="acertos2" placeholder="Acertos 2024">
                    </div>
                    <div class="input-group">
                        <label for="acertos3">Acertos 2025:</label>
                        <input type="number" id="acertos3" placeholder="Acertos 2025">
                    </div>
                    <div class="input-group">
                        <label for="acertosR">Redação:</label>
                        <input type="number" id="acertosR" placeholder="Nota Redação">
                    </div>

                    <div class="button-result-group">
                        <button id="calculateButton">Calcular</button>
                        <div id="result"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulário de Busca -->
        <div class="search-container">
            <div class="search-fields">
                <h2>Busque pelas suas preferências:</h2>
                <label for="categorySelect">Selecione a Categoria:</label>
                <select id="categorySelect">
                    <option value="">Selecione uma categoria</option>
                </select>

                <div class="filter-group">
                    <label for="institution">Instituição:</label>
                    <input type="text" id="institution" name="institution" list="institution-list" placeholder="Digite para filtrar...">
                    <datalist id="institution-list"></datalist>
                </div>
                <div class="filter-group">
                    <label for="course">Curso:</label>
                    <input type="text" id="course" name="course" list="course-list" placeholder="Digite para filtrar...">
                    <datalist id="course-list"></datalist>
                </div>

                <button id="searchButton" disabled>Buscar</button>
            </div>
        </div>

        <!-- Resultados -->
        <div id="results">
            <h2>Resultados:</h2>
            <div id="peopleList"></div>
        </div>

        <!-- Seção de colaboração -->
        <div class="collab-section">
            <h2>Já foi aprovado?</h2>
            <p>Compartilhe sua nota para ajudar futuros candidatos:</p>
            <a href="{{ url_for('formulario_page') }}" class="collab-button">Enviar minha Nota</a>
        </div>
        
        <!-- Footer -->
        <footer class="footer">
            <!-- Container interno para melhor controle de largura -->
            <div class="footer-inner">
                <h3>Grupo de Apoio para Vestibulandos 2025</h3>
                <p>Entre no grupo do WhatsApp e tire suas dúvidas com outros candidatos!</p>
                <a class="group-link" href="https://chat.whatsapp.com/EP0btFILC5s38znclDM3pO" target="_blank">Entrar no Grupo</a>
                
                <h3>Contato</h3>
                <div class="contact-container">
                    <div class="contact-box">
                        <p><strong>Kauan Yuri</strong></p>
                        <p>WhatsApp:
                            <a href="https://wa.me/5516994297281" target="_blank">16 99429-7281</a>
                        </p>
                        <p>Instagram:
                            <a href="https://www.instagram.com/dev.kauan" target="_blank">@dev.kauan</a>
                        </p>
                    </div>
                    <div class="contact-box">
                        <p><strong>Felipe Galvão</strong></p>
                        <p>WhatsApp:
                            <a href="https://wa.me/5516992145809" target="_blank">16 99214-5809</a>
                        </p>
                        <p>Instagram:
                            <a href="https://www.instagram.com/felipe.prazeresz" target="_blank">@felipe.prazeresz</a>
                        </p>
                    </div>
                </div>                
            </div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const categorySelect = document.getElementById('categorySelect');
            const institutionInput = document.getElementById('institution');
            const courseInput = document.getElementById('course');
            const searchButton = document.getElementById('searchButton');
            const resultsDiv = document.getElementById('results');
            const loadingDiv = document.getElementById('loading');
            const themeToggleButton = document.getElementById('theme-toggle');
            const instructionPopup = document.getElementById("instructionPopup");
            const closePopupButton = document.getElementById("closePopup");
            const calculateButton = document.getElementById('calculateButton');
            const notaCorteInput = document.getElementById('notaCorte');
            const suaNotaInput = document.getElementById('suaNota');
            const comparacaoResultado = document.getElementById('comparacaoResultado');
            const toggleCalculator = document.getElementById('toggleCalculator');
            const calculatorContainer = document.getElementById('calculatorContainer');

            // --- Funções de Carregamento e Utilitários ---
            function loadDatalistOptions(datalistId, endpoint) {
                fetch(endpoint)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        const datalist = document.getElementById(datalistId);
                        if (!datalist) {
                            console.error("Datalist element not found:", datalistId);
                            return;
                        }
                        datalist.innerHTML = ''; // Limpa opções anteriores
                        if (Array.isArray(data)) {
                            data.forEach(item => {
                                const option = document.createElement('option');
                                option.value = item;
                                datalist.appendChild(option);
                            });
                        } else {
                            console.error("Data for datalist is not an array:", data);
                        }
                    })
                    .catch(error => console.error(`Erro ao carregar opções para ${datalistId}:`, error));
            }

            function loadCategories() {
                fetch('/get_json_categories')
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        categorySelect.innerHTML = '<option value="">Selecione a Categoria de Cota</option>';
                        if (Array.isArray(data)) {
                            data.sort().forEach(category => {
                                const option = document.createElement('option');
                                option.value = category;
                                option.textContent = category;
                                categorySelect.appendChild(option);
                            });
                        } else {
                             console.error("Data for categories is not an array:", data);
                        }
                        categorySelect.disabled = false;
                    })
                    .catch(error => {
                        console.error('Erro ao carregar categorias:', error);
                        categorySelect.innerHTML = '<option value="">Erro ao carregar categorias</option>';
                    });
            }

            // --- Lógica de Eventos ---
            if (themeToggleButton) {
                themeToggleButton.addEventListener('click', () => {
                    document.body.classList.toggle('dark-mode');
                    localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
                });
            }

            if (closePopupButton) {
                closePopupButton.addEventListener('click', () => instructionPopup.style.display = "none");
            }

            categorySelect.addEventListener('change', () => {
                searchButton.disabled = !categorySelect.value;
            });

            searchButton.addEventListener('click', () => {
                const selectedCategory = categorySelect.value;
                const selectedCourse = courseInput.value.trim();
                const selectedInstitution = institutionInput.value.trim();

                if (!selectedCategory) {
                    alert('Por favor, selecione uma categoria de cota.');
                    return;
                }

                loadingDiv.style.display = 'block';
                resultsDiv.innerHTML = '';
                resultsDiv.style.display = 'none';

                fetch('/search_supabase', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        category: selectedCategory, 
                        course: selectedCourse, 
                        institution: selectedInstitution 
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { 
                            throw new Error(err.error || `Erro ${response.status} ao buscar dados.`); 
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    loadingDiv.style.display = 'none';
                    resultsDiv.style.display = 'block';
                    if (data && data.length > 0) {
                        const table = document.createElement('table');
                        const thead = document.createElement('thead');
                        const tbody = document.createElement('tbody');
                        thead.innerHTML = '<tr><th>Instituição</th><th>Curso</th><th>Nota de Corte (Número Único)</th></tr>';
                        data.forEach(item => {
                            const row = tbody.insertRow();
                            row.insertCell().textContent = item.instituicao || 'N/A';
                            row.insertCell().textContent = item.curso || 'N/A';
                            row.insertCell().textContent = item.numero_unico || 'N/A';
                        });
                        table.appendChild(thead);
                        table.appendChild(tbody);
                        resultsDiv.appendChild(table);
                    } else {
                        resultsDiv.innerHTML = '<p>Nenhum resultado encontrado para os critérios informados.</p>' +
                                             '<p>Isso pode ocorrer se:<ul><li>Não houver dados para essa combinação específica no banco.</li>' +
                                             '<li>Você digitou um nome de instituição ou curso que não corresponde exatamente (tente usar termos mais genéricos ou apenas parte do nome).</li>' +
                                             '<li>A categoria de cota selecionada não possui entradas para o curso/instituição buscados.</li></ul></p>';
                    }
                })
                .catch(error => {
                    loadingDiv.style.display = 'none';
                    resultsDiv.style.display = 'block';
                    resultsDiv.innerHTML = `<p>Erro ao buscar dados: ${error.message}</p>`;
                    console.error('Erro na busca:', error);
                });
            });
            
            if (toggleCalculator) {
                toggleCalculator.addEventListener('click', () => {
                    calculatorContainer.classList.toggle('visible');
                });
            }

            if (calculateButton) {
                calculateButton.addEventListener('click', () => {
                    const notaCorte = parseFloat(notaCorteInput.value);
                    const suaNota = parseFloat(suaNotaInput.value);
                    if (isNaN(notaCorte) || isNaN(suaNota)) {
                        comparacaoResultado.textContent = 'Por favor, insira valores numéricos válidos para as notas.';
                        return;
                    }
                    if (suaNota >= notaCorte) {
                        comparacaoResultado.textContent = 'Parabéns! Sua nota é suficiente.';
                        comparacaoResultado.style.color = 'green';
                    } else {
                        comparacaoResultado.textContent = `Você precisa de mais ${ (notaCorte - suaNota).toFixed(3) } pontos.`;
                        comparacaoResultado.style.color = 'red';
                    }
                });
            }

            // --- Inicialização ao Carregar a Página ---
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
            }
            if (instructionPopup) {
                 // Mostra o popup automaticamente ou baseado em alguma condição
                 // instructionPopup.style.display = "block"; 
            }
            loadCategories();
            loadDatalistOptions('institution-list', '/get_all_institutions');
            loadDatalistOptions('course-list', '/get_all_courses');
        });
    </script>
</body>
</html>