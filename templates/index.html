<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEUPROVAO</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <header class="top-nav">
        <div class="nav-inner">
            <div class="nav-left">
                <h1>MEUPROVAO<span class="dot">.</span></h1>
            </div>
            <div class="nav-actions">
                <span id="notaSalvaDisplayIndex" class="nav-button nota-salva-display" style="margin-right: 10px; font-size: 0.9em; cursor: default;"></span>
                <button class="nav-button" id="toggleCalculator">Minha Nota</button>
                <a href="{{ url_for('formulario_page') }}" class="nav-button">Enviar Nota</a>
                </div>
        </div>
    </header>

    <div class="main-container">

        <div id="popup" class="popup"> <div id="popupContent" class="popup-content">
                <h2>Observação</h2>
                <p>As notas exibidas são baseadas nos dados disponíveis e podem não representar o corte exato para aprovação. No futuro, teremos dados mais completos.</p>
                <button id="closePopup" class="popup-button">Entendi</button>
            </div>
        </div>

        <div class="containerCalculadora" id="calculatorContainer">
            <div class="calculadora">
                <h3>Calculadora de Nota</h3>
                <div class="input-row">
                    <div class="input-group">
                        <label for="acertos">Acertos 2023:</label>
                        <input type="number" id="acertos" placeholder="Ex: 75">
                    </div>
                    <div class="input-group">
                        <label for="acertos2">Acertos 2024:</label>
                        <input type="number" id="acertos2" placeholder="Ex: 80">
                    </div>
                    <div class="input-group">
                        <label for="acertos3">Acertos 2025:</label>
                        <input type="number" id="acertos3" placeholder="Ex: 85">
                    </div>
                    <div class="input-group">
                        <label for="acertosR">Redação:</label>
                        <input type="number" id="acertosR" placeholder="Ex: 18">
                    </div>
                </div>
                <div class="button-result-group">
                    <button id="calculateButton">Calcular</button>
                    <div id="result" class="calculator-result"></div>
                </div>
            </div>
        </div>

        <div class="search-container card-style">
            <div class="search-fields">
                <h2>Busque pelas suas preferências:</h2>
                <div class="form-group">
                    <label for="categorySelect">Selecione a Categoria:</label>
                    <select id="categorySelect">
                        <option value="">Selecione uma categoria</option>
                    </select>
                </div>

                <div class="filter-group form-group">
                    <label for="institution">Instituição:</label>
                    <input type="text" id="institution" name="institution" list="institution-list" placeholder="Digite ou selecione...">
                    <datalist id="institution-list"></datalist>
                </div>
                <div class="filter-group form-group">
                    <label for="course">Curso:</label>
                    <input type="text" id="course" name="course" list="course-list" placeholder="Digite ou selecione...">
                    <datalist id="course-list"></datalist>
                </div>

                <button id="searchButton" disabled>Buscar</button>
                <button type="button" id="clearFiltersButton" class="nav-button" style="margin-left: 10px;">Limpar Filtros</button>
            </div>
        </div>

        <div id="results-section" class="card-style" style="display: none;"> <h2>Resultados:</h2>
            <div id="loading" style="display: none;">
                <div class="spinner"></div>
                Carregando...
            </div>
            <div id="peopleList"></div> </div>


        <div class="collab-section card-style">
            <h2>Já foi aprovado?</h2>
            <p>Compartilhe sua nota para ajudar futuros candidatos e fortalecer nossa comunidade!</p>
            <a href="{{ url_for('formulario_page') }}" class="collab-button nav-button">Enviar minha Nota</a>
        </div>
        
        <footer class="footer">
            <div class="footer-inner">
                <div class="footer-section">
                    <h3>Grupo de Apoio</h3>
                    <p>Entre no grupo do WhatsApp e tire suas dúvidas com outros candidatos!</p>
                    <a class="group-link nav-button" href="https://chat.whatsapp.com/EP0btFILC5s38znclDM3pO" target="_blank">Entrar no Grupo</a>
                </div>
                
                <div class="footer-section">
                    <h3>Contato</h3>
                    <div class="contact-container">
                        <div class="contact-box">
                            <p><strong>Kauan Yuri</strong></p>
                            <p><a href="https://wa.me/5516994297281" target="_blank"><i class="icon-whatsapp"></i> 16 99429-7281</a></p>
                            <p><a href="https://www.instagram.com/dev.kauan" target="_blank"><i class="icon-instagram"></i> @dev.kauan</a></p>
                        </div>
                        <div class="contact-box">
                            <p><strong>Felipe Galvão</strong></p>
                            <p><a href="https://wa.me/5516992145809" target="_blank"><i class="icon-whatsapp"></i> 16 99214-5809</a></p>
                            <p><a href="https://www.instagram.com/felipe.prazeresz" target="_blank"><i class="icon-instagram"></i> @felipe.prazeresz</a></p>
                        </div>
                    </div>      
                </div>          
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 MEUPROVAO. Todos os direitos reservados.</p>
            </div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const categorySelect = document.getElementById('categorySelect');
            const institutionInput = document.getElementById('institution');
            const courseInput = document.getElementById('course');
            const searchButton = document.getElementById('searchButton');
            const resultsSection = document.getElementById('results-section');
            const peopleListDiv = document.getElementById('peopleList'); // Changed from resultsDiv
            const loadingDiv = document.getElementById('loading');
            // const themeToggleButton = document.getElementById('theme-toggle'); // Keep if you re-add the button
            const instructionPopup = document.getElementById("popup"); // Renamed for clarity
            const closePopupButton = document.getElementById("closePopup");
            const calculateButton = document.getElementById('calculateButton');
            const toggleCalculator = document.getElementById('toggleCalculator');
            const calculatorContainer = document.getElementById('calculatorContainer');
            const clearFiltersButton = document.getElementById('clearFiltersButton');

            // --- Theme Toggle (if button is re-added) ---
            // if (themeToggleButton) {
            //     themeToggleButton.addEventListener('click', () => {
            //         document.body.classList.toggle('dark-mode');
            //         localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            //     });
            //     // Apply saved theme
            //     if (localStorage.getItem('theme') === 'dark') {
            //         document.body.classList.add('dark-mode');
            //     }
            // }


            function updateResultCardsAppearance() {
                const notaSalva = localStorage.getItem('minhaNotaCalculada');
                let notaCalculada = null;
                if (notaSalva) {
                    notaCalculada = parseFloat(notaSalva);
                }

                const resultCards = document.querySelectorAll('.result-card');
                resultCards.forEach(card => {
                    const indicatorBar = card.querySelector('.result-card-indicator');
                    const notaCorteP = card.querySelector('.result-card-content p:nth-child(3)'); 
                    
                    if (!indicatorBar || !notaCorteP || !notaCorteP.textContent) return;

                    const notaCorteMatch = notaCorteP.textContent.match(/Nota de Corte: (\d+\.?\d*)/);
                    let notaCorteItem = null;
                    if (notaCorteMatch && notaCorteMatch[1]) {
                        notaCorteItem = parseFloat(notaCorteMatch[1]);
                    }

                    indicatorBar.classList.remove('bar-green', 'bar-red', 'bar-neutral');

                    if (notaCalculada !== null && notaCorteItem !== null) {
                        if (notaCalculada >= notaCorteItem) {
                            indicatorBar.classList.add('bar-green');
                        } else {
                            indicatorBar.classList.add('bar-red');
                        }
                    } else {
                        indicatorBar.classList.add('bar-neutral');
                    }
                });
            }

            function isValidDatalistValue(inputId, datalistId) {
                const inputElement = document.getElementById(inputId);
                const datalist = document.getElementById(datalistId);
                if (!inputElement || !datalist) {
                    console.error("Input ou Datalist não encontrado para validação:", inputId, datalistId);
                    return false; 
                }

                const inputValue = inputElement.value.trim();
                if (inputValue === "") return true; 

                for (let i = 0; i < datalist.options.length; i++) {
                    if (datalist.options[i].value === inputValue) {
                        return true;
                    }
                }
                return false;
            }

            function loadDatalistOptions(datalistId, endpoint) {
                fetch(endpoint)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        const datalist = document.getElementById(datalistId);
                        if (!datalist) {
                            console.error("Datalist element not found:", datalistId);
                            return;
                        }
                        datalist.innerHTML = ''; 
                        if (Array.isArray(data)) {
                            data.forEach(item => {
                                const option = document.createElement('option');
                                option.value = item;
                                datalist.appendChild(option);
                            });
                        } else {
                            console.error("Data for datalist is not an array:", data);
                        }
                    })
                    .catch(error => console.error(`Erro ao carregar opções para ${datalistId}:`, error));
            }

            function loadCategories() {
                fetch('/get_json_categories')
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        categorySelect.innerHTML = '<option value="">Selecione a Categoria de Cota</option>';
                        if (Array.isArray(data)) {
                            data.sort().forEach(category => {
                                const option = document.createElement('option');
                                option.value = category;
                                option.textContent = category;
                                categorySelect.appendChild(option);
                            });
                        } else {
                             console.error("Data for categories is not an array:", data);
                        }
                        categorySelect.disabled = false;
                    })
                    .catch(error => {
                        console.error('Erro ao carregar categorias:', error);
                        categorySelect.innerHTML = '<option value="">Erro ao carregar categorias</option>';
                    });
            }

            // --- Event Listeners ---
            if (closePopupButton && instructionPopup) { //
                closePopupButton.addEventListener('click', () => instructionPopup.classList.remove('visible')); //
                 // Show popup if needed, for example, on first visit
                // if (!localStorage.getItem('popupShown')) {
                //    instructionPopup.classList.add('visible');
                //    localStorage.setItem('popupShown', 'true');
                // }
            }


            if (categorySelect) {
                categorySelect.addEventListener('change', () => {
                    searchButton.disabled = !categorySelect.value;
                });
            }

            if (searchButton) {
                searchButton.addEventListener('click', () => {
                    const selectedCategory = categorySelect.value;
                    const selectedCourse = courseInput.value.trim();
                    const selectedInstitution = institutionInput.value.trim();

                    if (!selectedCategory) {
                        alert('Por favor, selecione uma categoria de cota.');
                        return;
                    }

                    if (institutionInput.value.trim() !== "" && !isValidDatalistValue('institution', 'institution-list')) {
                        alert('Por favor, selecione uma instituição válida da lista ou deixe o campo em branco.');
                        return;
                    }
                    if (courseInput.value.trim() !== "" && !isValidDatalistValue('course', 'course-list')) {
                        alert('Por favor, selecione um curso válido da lista ou deixe o campo em branco.');
                        return;
                    }

                    loadingDiv.style.display = 'flex'; // Changed to flex for spinner centering
                    peopleListDiv.innerHTML = '';
                    resultsSection.style.display = 'block'; // Show results section

                    fetch('/search_supabase', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            category: selectedCategory, 
                            course: selectedCourse, 
                            institution: selectedInstitution 
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { 
                                throw new Error(err.error || `Erro ${response.status} ao buscar dados.`); 
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        loadingDiv.style.display = 'none';
                        peopleListDiv.innerHTML = ''; 

                        if (data && data.length > 0) {
                            data.forEach(item => {
                                const resultCard = document.createElement('div');
                                resultCard.className = 'result-card';

                                const indicatorBar = document.createElement('div');
                                indicatorBar.className = 'result-card-indicator'; 

                                const contentDiv = document.createElement('div');
                                contentDiv.className = 'result-card-content';

                                const instituicaoP = document.createElement('p');
                                instituicaoP.innerHTML = `<strong>Instituição:</strong> ${item.instituicao || 'N/A'}`;
                                contentDiv.appendChild(instituicaoP);

                                const cursoP = document.createElement('p');
                                cursoP.innerHTML = `<strong>Curso:</strong> ${item.curso || 'N/A'}`;
                                contentDiv.appendChild(cursoP);

                                const notaP = document.createElement('p');
                                const notaCorteItem = item.numero_unico !== null ? parseFloat(item.numero_unico) : null;
                                notaP.innerHTML = `<strong>Nota de Corte:</strong> ${notaCorteItem !== null ? notaCorteItem.toFixed(3) : 'N/A'}`;
                                contentDiv.appendChild(notaP);

                                const cotaP = document.createElement('p');
                                cotaP.innerHTML = `<strong>Grupo (Cota):</strong> ${item.tipo_cota || 'N/A'}`;
                                contentDiv.appendChild(cotaP);
                                
                                indicatorBar.classList.add('bar-neutral'); 

                                resultCard.appendChild(indicatorBar);
                                resultCard.appendChild(contentDiv);
                                peopleListDiv.appendChild(resultCard);
                            });
                            updateResultCardsAppearance(); 
                        } else {
                            peopleListDiv.innerHTML = '<p class="no-results">Nenhum resultado encontrado para os critérios informados.</p>' +
                                                    '<p class="no-results-info">Isso pode ocorrer se:<ul><li>Não houver dados para essa combinação específica.</li>' +
                                                    '<li>A instituição ou curso digitado não corresponde exatamente.</li>' +
                                                    '<li>A categoria de cota não possui entradas para o curso/instituição.</li></ul></p>';
                        }
                    })
                    .catch(error => {
                        loadingDiv.style.display = 'none';
                        peopleListDiv.innerHTML = `<p class="error-message">Erro ao buscar dados: ${error.message}</p>`;
                        console.error('Erro na busca:', error);
                    });
                });
            }
            
            if (toggleCalculator && calculatorContainer) {
                toggleCalculator.addEventListener('click', () => {
                    calculatorContainer.classList.toggle('visible'); //
                });
            }

            if (calculateButton) {
                calculateButton.addEventListener('click', () => {
                    const acertosInput = document.getElementById('acertos');
                    const acertos2Input = document.getElementById('acertos2');
                    const acertos3Input = document.getElementById('acertos3');
                    const acertosRInput = document.getElementById('acertosR');
                    const resultDisplay = document.getElementById('result');

                    // Validação dos campos
                    if (acertosInput.value === '' || acertos2Input.value === '' || acertos3Input.value === '' || acertosRInput.value === '') {
                        resultDisplay.innerHTML = '<strong style="color: red;">Preencha todos os campos da calculadora.</strong>';
                        return;
                    }

                    let acertos = Number(acertosInput.value);
                    let acertos2 = Number(acertos2Input.value);
                    let acertos3 = Number(acertos3Input.value);
                    let acertosR = Number(acertosRInput.value);

                    let notaCalculadora = ((acertos / 90) * 0.15) 
                                            + ((acertos2 / 90) * 0.25)
                                            + ((acertos3 / 90) * 0.40) 
                                            + ((acertosR / 20) * 0.20);

                    let notaReal = (notaCalculadora * 100).toFixed(3);
                    document.getElementById('result').innerHTML = `Sua nota é: <strong>${notaReal}</strong>`;
                    salvarNotaCalculada(notaReal); // Salva e atualiza a exibição
                    updateResultCardsAppearance(); 
                });
            }

            // --- Funções para nota salva ---
            function exibirNotaSalvaIndex() {
                const notaSalva = localStorage.getItem('minhaNotaCalculada');
                const displayElement = document.getElementById('notaSalvaDisplayIndex');
                if (displayElement) {
                    if (notaSalva) {
                        displayElement.textContent = `Nota: ${notaSalva}`;
                        displayElement.style.display = 'inline-block'; // Garante visibilidade
                    } else {
                        displayElement.textContent = '';
                        displayElement.style.display = 'none'; // Oculta se não houver nota
                    }
                }
            }

            function salvarNotaCalculada(nota) {
                localStorage.setItem('minhaNotaCalculada', nota);
                exibirNotaSalvaIndex();
            }

            // --- Initializations ---
            // Apply saved theme (if theme toggle is used)
            // if (localStorage.getItem('theme') === 'dark') {
            //     document.body.classList.add('dark-mode');
            // }

            // Auto-show instruction popup on first visit example:
            if (instructionPopup && !localStorage.getItem('meuprovao_popup_shown')) {
                 instructionPopup.classList.add('visible');
                 localStorage.setItem('meuprovao_popup_shown', 'true');
            }

            loadCategories();
            loadDatalistOptions('institution-list', '/get_all_institutions');
            loadDatalistOptions('course-list', '/get_all_courses');
            exibirNotaSalvaIndex(); // Exibe a nota salva e preenche o campo de comparação ao carregar

            function performSearch() {
                const selectedCategory = categorySelect.value;
                const selectedInstitution = institutionInput.value.trim();
                const selectedCourse = courseInput.value.trim();

                if (!selectedCategory) {
                    alert("Por favor, selecione uma categoria.");
                    searchButton.disabled = false;
                    return;
                }

                if (!isValidDatalistValue('institution', 'institution-list') && selectedInstitution !== "") {
                    alert("Por favor, selecione uma instituição válida da lista ou deixe o campo em branco.");
                    searchButton.disabled = false;
                    return;
                }
                if (!isValidDatalistValue('course', 'course-list') && selectedCourse !== "") {
                    alert("Por favor, selecione um curso válido da lista ou deixe o campo em branco.");
                    searchButton.disabled = false;
                    return;
                }

                loadingDiv.style.display = 'block';
                peopleListDiv.innerHTML = '';
                resultsSection.style.display = 'block';
                searchButton.disabled = true;


                fetch('/search_supabase', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        category: selectedCategory,
                        institution: selectedInstitution,
                        course: selectedCourse
                    }),
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || 'Erro na busca'); });
                    }
                    return response.json();
                })
                .then(data => {
                    peopleListDiv.innerHTML = '';
                    let resultados = data;

                    if (resultados.length > 0) {
                        // Ordena os resultados por numero_unico em ordem decrescente
                        resultados.sort((a, b) => {
                            const notaA = parseFloat(a.numero_unico) || 0;
                            const notaB = parseFloat(b.numero_unico) || 0;
                            return notaB - notaA;
                        });

                        resultados.forEach(person => {
                            const personDiv = document.createElement('div');
                            personDiv.classList.add('result-card');

                            const indicatorBar = document.createElement('div');
                            indicatorBar.classList.add('result-card-indicator');
                            personDiv.appendChild(indicatorBar);

                            const contentDiv = document.createElement('div');
                            contentDiv.classList.add('result-card-content');
                            contentDiv.innerHTML = `
                                <p><strong>Instituição:</strong> ${person.instituicao || 'N/A'}</p>
                                <p><strong>Curso:</strong> ${person.curso || 'N/A'}</p>
                                <p><strong>Nota de Corte:</strong> ${person.numero_unico !== null ? parseFloat(person.numero_unico).toFixed(3) : 'N/A'}</p>
                                <p><strong>Tipo de Cota:</strong> ${person.tipo_cota || 'N/A'}</p>
                            `;
                            personDiv.appendChild(contentDiv);
                            peopleListDiv.appendChild(personDiv);
                        });
                    } else {
                        peopleListDiv.innerHTML = '<p>Nenhum resultado encontrado para os filtros aplicados.</p>';
                    }
                    updateResultCardsAppearance();
                })
                .catch(error => {
                    console.error('Erro:', error);
                    peopleListDiv.innerHTML = `<p>Erro ao buscar dados: ${error.message}</p>`;
                })
                .finally(() => {
                    loadingDiv.style.display = 'none';
                    searchButton.disabled = false;
                });
            }

            function clearFilters() {
                categorySelect.value = '';
                institutionInput.value = '';
                courseInput.value = '';
                peopleListDiv.innerHTML = '';
                resultsSection.style.display = 'none';
                searchButton.disabled = true; 
                checkIfSearchCanBeEnabled();
                updateResultCardsAppearance();
                exibirNotaSalvaIndex();
            }
            
            if (clearFiltersButton) {
                clearFiltersButton.addEventListener('click', clearFilters);
            }

            // Enable search button only when category is selected
            if (searchButton) {
                searchButton.addEventListener('click', performSearch);
            }
        });
    </script>
</body>
</html>