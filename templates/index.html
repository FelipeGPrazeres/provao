<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEUPROVAO</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <header class="top-nav">
        <div class="nav-inner">
            <div class="nav-left">
                <h1>MEUPROVAO<span class="dot">.</span></h1>
                <button class="nav-button" id="toggleCalculator">Minha Nota</button>
                <a href="{{ url_for('formulario_page') }}" class="nav-button">Enviar Nota</a>
            </div>
        </div>
    </header>

    <!-- Container principal -->
    <div class="main-container">

        <!-- Popup (Oculto por padrão) -->
        <div id="popup" class="popup">
            <div id="popupContent">
                <h2>Observação</h2>
                <p>As notas exibidas são baseadas nos dados disponíveis e podem não representar o corte exato para aprovação. No futuro, teremos dados mais completos.</p>
                <p>O site está no início do desenvolvimento!</p>
                <button id="closePopup">Entendi</button>
            </div>
        </div>

        <!-- Seção da Calculadora (expansão via max-height) -->
        <div class="containerCalculadora" id="calculatorContainer">
            <div class="calculadora">
                <div class="input-row">
                    <div class="input-group">
                        <label for="acertos">Acertos 2023:</label>
                        <input type="number" id="acertos" placeholder="Acertos 2023">
                    </div>
                    <div class="input-group">
                        <label for="acertos2">Acertos 2024:</label>
                        <input type="number" id="acertos2" placeholder="Acertos 2024">
                    </div>
                    <div class="input-group">
                        <label for="acertos3">Acertos 2025:</label>
                        <input type="number" id="acertos3" placeholder="Acertos 2025">
                    </div>
                    <div class="input-group">
                        <label for="acertosR">Redação:</label>
                        <input type="number" id="acertosR" placeholder="Nota Redação">
                    </div>

                    <div class="button-result-group">
                        <button id="calculateButton">Calcular</button>
                        <div id="result"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulário de Busca -->
        <div class="search-container">
            <div class="search-fields">
                <h2>Busque pelas suas preferências:</h2>
                <label for="categorySelect">Selecione a Categoria:</label>
                <select id="categorySelect">
                    <option value="">Selecione uma categoria</option>
                </select>

                <label for="institutionInput">Filtrar por Instituição (opcional):</label>
                <input type="text" id="institutionInput" list="institutionsList" placeholder="Digite o nome da Instituição (opcional)">
                <datalist id="institutionsList"></datalist>

                <label for="courseInput">Selecione ou digite o curso:</label>
                <input type="text" id="courseInput" list="coursesList" placeholder="Digite o nome do curso" disabled>
                <datalist id="coursesList"></datalist>

                <button id="searchButton" disabled>Buscar</button>
            </div>
        </div>

        <!-- Resultados -->
        <div id="results">
            <h2>Resultados:</h2>
            <div id="peopleList"></div>
        </div>

        <!-- Seção de colaboração -->
        <div class="collab-section">
            <h2>Já foi aprovado?</h2>
            <p>Compartilhe sua nota para ajudar futuros candidatos:</p>
            <a href="{{ url_for('formulario_page') }}" class="collab-button">Enviar minha Nota</a>
        </div>
        
        <!-- Footer -->
        <footer class="footer">
            <!-- Container interno para melhor controle de largura -->
            <div class="footer-inner">
                <h3>Grupo de Apoio para Vestibulandos 2025</h3>
                <p>Entre no grupo do WhatsApp e tire suas dúvidas com outros candidatos!</p>
                <a class="group-link" href="https://chat.whatsapp.com/EP0btFILC5s38znclDM3pO" target="_blank">Entrar no Grupo</a>
                
                <h3>Contato</h3>
                <div class="contact-container">
                    <div class="contact-box">
                        <p><strong>Kauan Yuri</strong></p>
                        <p>WhatsApp:
                            <a href="https://wa.me/5516994297281" target="_blank">16 99429-7281</a>
                        </p>
                        <p>Instagram:
                            <a href="https://www.instagram.com/dev.kauan" target="_blank">@dev.kauan</a>
                        </p>
                    </div>
                    <div class="contact-box">
                        <p><strong>Felipe Galvão</strong></p>
                        <p>WhatsApp:
                            <a href="https://wa.me/5516992145809" target="_blank">16 99214-5809</a>
                        </p>
                        <p>Instagram:
                            <a href="https://www.instagram.com/felipe.prazeresz" target="_blank">@felipe.prazeresz</a>
                        </p>
                    </div>
                </div>                
            </div>
        </footer>
    </div>

    <script>
        // Configuração do Cliente Supabase
        const SUPABASE_URL = 'https://iradczvlimgyukwbwqcl.supabase.co'; // Substitua pela sua URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlyYWRjenZsaW1neXVrd2J3cWNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxMTQwMDcsImV4cCI6MjA2MzY5MDAwN30.CcLvcjhUaNvgSEHFunka_Er-RQ8iwMKInP5lvIrlqIY'; // Substitua pela sua chave anônima
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const categorySelect = document.getElementById('categorySelect');
        const institutionInput = document.getElementById('institutionInput');
        const courseInput = document.getElementById('courseInput');
        const searchButton = document.getElementById('searchButton');
        const calculateButton = document.getElementById('calculateButton');
        const resultsDiv = document.getElementById('results');
        const peopleListDiv = document.getElementById('peopleList');
        const coursesList = document.getElementById('coursesList');
        const institutionsList = document.getElementById('institutionsList');
        const popup = document.getElementById('popup');
        const closePopup = document.getElementById('closePopup');
        
        const toggleCalculator = document.getElementById('toggleCalculator');
        const calculatorContainer = document.getElementById('calculatorContainer');

        let allCourses = {};
        let allInstitutions = {};
        let currentCategory = null;
        let notaReal = 0;
        let notaCalculadora = 0;

        // Exibe popup ao carregar
        window.addEventListener('DOMContentLoaded', () => {
            popup.style.display = "block";
        });

        closePopup.addEventListener("click", () => {
            popup.style.display = "none";
        });

        // Esconde resultados inicialmente
        resultsDiv.style.display = 'none';

        // Fetch de categorias (tipos de cota) do Supabase
        async function fetchCategories() {
            try {
                // Usando 'dados_formulario' como a tabela principal
                const { data, error } = await supabase
                    .from('dados_formulario') 
                    .select('tipo_cota');

                if (error) {
                    console.error('Erro ao buscar categorias (tipos de cota):', error);
                    return;
                }

                if (data) {
                    // Obter valores distintos e remover nulos/vazios
                    const distinctCategories = [...new Set(data.map(item => item.tipo_cota).filter(Boolean))];
                    distinctCategories.sort(); // Opcional: ordenar categorias

                    categorySelect.innerHTML = '<option value="">Selecione uma categoria</option>'; // Limpar e adicionar placeholder
                    distinctCategories.forEach(categoryValue => {
                        let option = document.createElement('option');
                        option.value = categoryValue;
                        option.textContent = categoryValue; // Exibe o valor da cota
                        categorySelect.appendChild(option);
                    });
                }
            } catch (err) {
                console.error('Erro inesperado ao buscar categorias (tipos de cota):', err);
            }
        }
        fetchCategories();

        categorySelect.addEventListener('change', async () => {
            currentCategory = categorySelect.value; // currentCategory agora é um tipo_cota
            courseInput.disabled = !currentCategory;
            searchButton.disabled = !currentCategory;
            institutionInput.disabled = !currentCategory; // Habilitar input de instituição
            courseInput.value = '';
            institutionInput.value = '';
            coursesList.innerHTML = '';
            institutionsList.innerHTML = '';
            
            allCourses[currentCategory] = []; 
            allInstitutions[currentCategory] = [];

            if (currentCategory) {
                try {
                    // Fetch de cursos para a categoria (tipo_cota) selecionada
                    const { data: coursesData, error: coursesError } = await supabase
                        .from('dados_formulario')
                        .select('curso')
                        .eq('tipo_cota', currentCategory);

                    if (coursesError) {
                        console.error('Erro ao buscar cursos:', coursesError);
                    } else if (coursesData) {
                        allCourses[currentCategory] = [...new Set(coursesData.map(item => item.curso).filter(Boolean))].sort();
                    }

                    // Fetch de instituições para a categoria (tipo_cota) selecionada
                    const { data: institutionsData, error: institutionsError } = await supabase
                        .from('dados_formulario')
                        .select('instituicao')
                        .eq('tipo_cota', currentCategory);

                    if (institutionsError) {
                        console.error('Erro ao buscar instituições:', institutionsError);
                    } else if (institutionsData) {
                        allInstitutions[currentCategory] = [...new Set(institutionsData.map(item => item.instituicao).filter(Boolean))].sort();
                    }
                } catch (err) {
                    console.error('Erro ao buscar cursos ou instituições:', err);
                }
            } else {
                 institutionInput.disabled = true;
            }
        });

        institutionInput.addEventListener('input', () => {
            const currentInput = institutionInput.value;
            institutionsList.innerHTML = '';

            if (currentInput.length >= 3 && currentCategory && allInstitutions[currentCategory]) {
                const filteredInstitutions = allInstitutions[currentCategory].filter(institution =>
                    institution.toLowerCase().startsWith(currentInput.toLowerCase())
                );

                filteredInstitutions.forEach(institution => {
                    let option = document.createElement('option');
                    option.value = institution;
                    institutionsList.appendChild(option);
                });
            }
        });

        courseInput.addEventListener('input', () => {
            const currentInput = courseInput.value;
            coursesList.innerHTML = '';

            if (currentInput.length >= 3 && currentCategory && allCourses[currentCategory]) {
                const filteredCourses = allCourses[currentCategory].filter(course =>
                    course.toLowerCase().startsWith(currentInput.toLowerCase())
                );

                filteredCourses.forEach(course => {
                    let option = document.createElement('option');
                    option.value = course;
                    coursesList.appendChild(option);
                });
            }
        });

        searchButton.addEventListener('click', async () => {
            const selectedCourse = courseInput.value;
            const selectedInstitution = institutionInput.value;
            // currentCategory já está definido pelo categorySelect.addEventListener e é o 'tipo_cota'

            if (!currentCategory) { // Verifica se uma categoria (tipo_cota) foi selecionada
                alert("Por favor, selecione uma categoria (tipo de cota).");
                return;
            }
            
            if (!selectedCourse) {
                alert("Por favor, digite ou selecione um curso.");
                return;
            }

            try {
                let query = supabase
                    .from('dados_formulario')
                    .select('instituicao, curso, numero_unico, tipo_cota')
                    .eq('tipo_cota', currentCategory)
                    .eq('curso', selectedCourse);

                if (selectedInstitution) {
                    query = query.eq('instituicao', selectedInstitution);
                }

                const { data: people, error } = await query;

                if (error) {
                    console.error('Erro ao buscar resultados:', error);
                    peopleListDiv.innerHTML = '<p>Erro ao buscar dados. Tente novamente.</p>';
                    resultsDiv.style.display = 'block'; // Manter visível para mostrar o erro
                    return;
                }

                document.getElementById('results').style.display = 'block';
                peopleListDiv.innerHTML = people && people.length > 0
                    ? people.map(person => {
                        const instituicao = person.instituicao || 'N/A';
                        const curso = person.curso || 'N/A';
                        const nota = person.numero_unico !== null ? parseFloat(person.numero_unico).toFixed(3) : 'N/A';
                        const grupo = person.tipo_cota || 'N/A';

                        const notaPessoa = parseFloat(person.numero_unico);

                        // Comparação com notaReal (da calculadora)
                        if (!isNaN(notaPessoa) && notaReal !== null && notaReal > 0 && notaPessoa < notaReal) {
                            return `<div class="personMaior">
                                <p><strong>Instituição:</strong> ${instituicao}</p>
                                <p><strong>Curso:</strong> ${curso}</p>
                                <p><strong>Nota:</strong> ${nota}</p>
                                <p><strong>Grupo (Cota):</strong> ${grupo}</p>
                            </div>`;
                        } else {
                            return `<div class="person">
                                <p><strong>Instituição:</strong> ${instituicao}</p>
                                <p><strong>Curso:</strong> ${curso}</p>
                                <p><strong>Nota:</strong> ${nota}</p>
                                <p><strong>Grupo (Cota):</strong> ${grupo}</p>
                            </div>`;
                        }
                    }).join('')
                    : '<p>Nenhum aluno encontrado para os critérios selecionados.</p>';
            } catch (err) {
                console.error('Erro inesperado na busca:', err);
                peopleListDiv.innerHTML = '<p>Ocorreu um erro inesperado. Tente novamente.</p>';
                resultsDiv.style.display = 'block'; // Manter visível para mostrar o erro
            }
        });
        calculateButton.addEventListener('click', () => {
            let acertos = Number(document.getElementById('acertos').value);
            let acertos2 = Number(document.getElementById('acertos2').value);
            let acertos3 = Number(document.getElementById('acertos3').value);
            let acertosR = Number(document.getElementById('acertosR').value);

            notaCalculadora = ((acertos / 90) * 0.15) 
                            + ((acertos2 / 90) * 0.25)
                            + ((acertos3 / 90) * 0.40) 
                            + ((acertosR / 20) * 0.20);

            notaReal = (notaCalculadora * 100).toFixed(3);
            document.getElementById('result').innerHTML = `<h2>Sua nota é: ${notaReal}</h2>`;
        });

        // Exibe/oculta calculadora com animação de expansão (similar ao menu)
        toggleCalculator.addEventListener('click', () => {
            calculatorContainer.classList.toggle('visible');
        });
    </script>
</body>
</html>