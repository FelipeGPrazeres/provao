<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enviar Dados</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <!-- Popup de Instruções (Oculto por padrão, exibido via JS) -->
    <div id="formPopup" class="popup" style="display: none;">
        <div id="formPopupContent" class="popup-content">
            <h2>Atenção!</h2>
            <p>Caso não saiba sua nota, aperte em "Minha Nota" e use nossa calculadora para descobrir.</p>
            <p style="font-size: 1.1em;">Apresente apenas sua primeira opção e tenha certeza dos dados que está colocando, pois são de <strong style="color: red;">envio único</strong>.</p>
            <button id="closeFormPopup">Entendi</button>
        </div>
    </div>

    <header class="top-nav">
        <div class="nav-inner">
            <div class="nav-left">
                <h1>MEUPROVAO<span class="dot">.</span></h1>
                <button class="nav-button" id="toggleCalculatorSubmit">Minha Nota</button>
            </div>
            <div class="nav-right">
                <a href="{{ url_for('index_page') }}" class="nav-button">Buscar Notas</a>
            </div>
        </div>
    </header>

    <div class="main-container">
        <div class="containerCalculadora" id="calculatorContainerSubmit">
            <div class="calculadora">
                <div class="input-row">
                    <div class="input-group">
                        <label for="acertosSubmit">Acertos 2023:</label>
                        <input type="number" id="acertosSubmit" placeholder="Acertos 2023">
                    </div>
                    <div class="input-group">
                        <label for="acertos2Submit">Acertos 2024:</label>
                        <input type="number" id="acertos2Submit" placeholder="Acertos 2024">
                    </div>
                    <div class="input-group">
                        <label for="acertos3Submit">Acertos 2025:</label>
                        <input type="number" id="acertos3Submit" placeholder="Acertos 2025">
                    </div>
                    <div class="input-group">
                        <label for="acertosRSubmit">Redação:</label>
                        <input type="number" id="acertosRSubmit" placeholder="Nota Redação">
                    </div>

                    <div class="button-result-group">
                        <button id="calculateButtonSubmit">Calcular</button>
                        <div id="resultSubmit"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="search-container">
            <div class="search-fields">
                <h2>Enviar Novos Dados</h2>
                <form id="dataForm">
                    <div class="input-group">
                        <label for="campo1">Nome: 
                            <span id="nomeInfoTrigger" style="cursor: pointer; font-weight: bold; color: blue; margin-left: 5px;" title="Informações sobre o campo Nome">(?)</span>
                        </label>
                        <input type="text" id="campo1" placeholder="Digite seu nome completo" required>
                    </div>

                    <!-- Modal/Tooltip para Informação do Nome (Oculto por padrão) -->
                    <div id="nomeInfoModal" class="popup" style="display: none; z-index: 1001; position: fixed; /* Para centralizar melhor */ top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; max-width: 500px;">
                        <div class="popup-content" style="text-align: center;">
                            <h2>Informação sobre o Nome</h2>
                            <p style="text-align: left;">Nome apenas para verificação de unicidade dos dados, não será disponibilizado nas buscas. Caso alguém com o nome EXATAMENTE igual ao seu já tenha feito uma submissão, mande para nós por email.</p>
                            <button id="closeNomeInfoModal" style="margin-top: 15px;">Fechar</button>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="campo2">Tipo de Cota:</label>
                        <select id="campo2" required>
                            <option value="">Selecione uma opção</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="instituicao">Nome da Instituição:</label>
                        <input type="text" id="instituicao" name="instituicao" list="institution-list-form" required placeholder="Digite para filtrar...">
                        <datalist id="institution-list-form"></datalist>
                    </div>

                    <div class="form-group">
                        <label for="curso">Nome do Curso:</label>
                        <input type="text" id="curso" name="curso" list="course-list-form" required placeholder="Digite para filtrar...">
                        <datalist id="course-list-form"></datalist>
                    </div>

                    <div class="input-group">
                        <label for="campoUnicoNumero">Sua nota final:</label>
                        <input type="number" id="campoUnicoNumero" placeholder="Digite sua nota" step="any" required>
                    </div>
                    
                    <button type="submit" class="nav-button">Enviar Dados</button>
                </form>
                <p id="formMessage"></p>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-inner">
            <h3>Grupo de Apoio para Vestibulandos 2025</h3>
            <p>Entre no grupo do WhatsApp e tire suas dúvidas com outros candidatos!</p>
            <a class="group-link" href="https://chat.whatsapp.com/EP0btFILC5s38znclDM3pO" target="_blank">Entrar no Grupo</a>
            <h3>Contato</h3>
            <div class="contact-container">
                <div class="contact-box">
                    <p><strong>Kauan Yuri</strong></p>
                    <p>WhatsApp:
                        <a href="https://wa.me/5516994297281" target="_blank">16 99429-7281</a>
                    </p>
                    <p>Instagram:
                        <a href="https://www.instagram.com/dev.kauan" target="_blank">@dev.kauan</a>
                    </p>
                </div>
                <div class="contact-box">
                    <p><strong>Felipe Galvão</strong></p>
                    <p>WhatsApp:
                        <a href="https://wa.instagram.com/felipe.prazeresz" target="_blank">16 99214-5809</a>
                    </p>
                    <p>Instagram:
                        <a href="https://www.instagram.com/felipe.prazeresz" target="_blank">@felipe.prazeresz</a>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        const SUPABASE_URL = 'https://iradczvlimgyukwbwqcl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlyYWRjenZsaW1neXVrd2J3cWNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxMTQwMDcsImV4cCI6MjA2MzY5MDAwN30.CcLvcjhUaNvgSEHFunka_Er-RQ8iwMKInP5lvIrlqIY';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const formMessage = document.getElementById('formMessage');
        const tipoCotaSelect = document.getElementById('campo2');
        const institutionInputForm = document.getElementById('instituicao');
        const courseInputForm = document.getElementById('curso');

        const toggleCalculatorSubmit = document.getElementById('toggleCalculatorSubmit');
        const calculatorContainerSubmit = document.getElementById('calculatorContainerSubmit');
        const calculateButtonSubmit = document.getElementById('calculateButtonSubmit');
        let notaRealSubmit = 0;

        toggleCalculatorSubmit.addEventListener('click', () => {
            calculatorContainerSubmit.classList.toggle('visible');
        });

        calculateButtonSubmit.addEventListener('click', () => {
            let acertos = Number(document.getElementById('acertosSubmit').value);
            let acertos2 = Number(document.getElementById('acertos2Submit').value);
            let acertos3 = Number(document.getElementById('acertos3Submit').value);
            let acertosR = Number(document.getElementById('acertosRSubmit').value);

            let notaCalculadoraSubmit = ((acertos / 90) * 0.15) 
                                    + ((acertos2 / 90) * 0.25)
                                    + ((acertos3 / 90) * 0.40) 
                                    + ((acertosR / 20) * 0.20);

            notaRealSubmit = (notaCalculadoraSubmit * 100).toFixed(3);
            document.getElementById('resultSubmit').innerHTML = `<h2>Sua nota é: ${notaRealSubmit}</h2>`;
        });

        async function loadFormCategories() {
            try {
                const response = await fetch('/get_json_categories');
                if (!response.ok) throw new Error(`HTTP error! ${response.status}`);
                const categoriesFromJson = await response.json();

                tipoCotaSelect.innerHTML = '<option value="">Selecione uma opção</option>';
                if (categoriesFromJson && categoriesFromJson.length > 0) {
                    categoriesFromJson.sort().forEach(categoryValue => {
                        let option = document.createElement('option');
                        option.value = categoryValue;
                        option.textContent = categoryValue;
                        tipoCotaSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar tipos de cota para o formulário:', error);
            }
        }

        function loadDatalistOptions(datalistId, endpoint) {
            fetch(endpoint)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    const datalist = document.getElementById(datalistId);
                    if (!datalist) {
                        console.error("Datalist element not found:", datalistId);
                        return;
                    }
                    datalist.innerHTML = ''; 
                    if (Array.isArray(data)) {
                        data.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item;
                            datalist.appendChild(option);
                        });
                    } else {
                        console.error("Data for datalist is not an array:", data);
                    }
                })
                .catch(error => console.error(`Erro ao carregar opções para ${datalistId}:`, error));
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadFormCategories();
            loadDatalistOptions('institution-list-form', '/get_all_institutions');
            loadDatalistOptions('course-list-form', '/get_all_courses');
        });

        document.getElementById('dataForm').addEventListener('submit', async function(event) {
            console.log('Form submission initiated.');
            event.preventDefault(); 
            console.log('Default form submission prevented.');

            const nomeCompleto = document.getElementById('campo1').value;
            const tipoCota = document.getElementById('campo2').value;
            const instituicao = document.getElementById('instituicao').value;
            const curso = document.getElementById('curso').value;
            const notaFinal = parseFloat(document.getElementById('campoUnicoNumero').value);

            if (!tipoCota) {
                formMessage.textContent = 'Por favor, selecione uma opção para o Tipo de Cota.';
                formMessage.style.color = 'red';
                return;
            }
            
            formMessage.textContent = ''; 

            if (!isValidDatalistValue('instituicao', 'institution-list-form')) {
                formMessage.textContent = 'Por favor, selecione uma instituição válida da lista.';
                formMessage.style.color = 'red';
                return;
            }
            if (!isValidDatalistValue('curso', 'course-list-form')) {
                formMessage.textContent = 'Por favor, selecione um curso válido da lista.';
                formMessage.style.color = 'red';
                return;
            }

            console.log('Data collected:', { nomeCompleto, tipoCota, instituicao, curso, notaFinal });

            console.log('Attempting to send data to Supabase...');
            try {
                const { data, error } = await supabaseClient
                    .from('dados_formulario') 
                    .insert([
                        { 
                            nome: nomeCompleto,
                            tipo_cota: tipoCota,
                            instituicao: instituicao,
                            curso: curso,
                            numero_unico: notaFinal
                        }
                    ]);

                if (error) {
                    console.error('Erro ao enviar dados para o Supabase:', error);
                    formMessage.textContent = 'Erro ao enviar dados: ' + error.message;
                    formMessage.style.color = 'red';
                } else {
                    console.log('Dados enviados com sucesso para o Supabase:', data);
                    formMessage.textContent = 'Dados enviados com sucesso!';
                    formMessage.style.color = 'green';
                    document.getElementById('dataForm').reset();
                }
            } catch (err) {
                console.error('Erro inesperado durante a submissão:', err);
                formMessage.textContent = 'Ocorreu um erro inesperado. Tente novamente.';
                formMessage.style.color = 'red';
            }
        });

        // Popup de Instruções do Formulário
        const formPopup = document.getElementById('formPopup');
        const closeFormPopup = document.getElementById('closeFormPopup');

        if (formPopup && closeFormPopup) { // Verifica se os elementos existem
            window.addEventListener('DOMContentLoaded', () => {
                formPopup.style.display = "block"; // Exibe o popup ao carregar
            });

            closeFormPopup.addEventListener("click", () => {
                formPopup.style.display = "none";
            });
        } else {
            console.warn("Elementos do popup inicial do formulário (formPopup ou closeFormPopup) não encontrados.");
        }

        // Modal de Informação do Campo Nome
        const nomeInfoTrigger = document.getElementById('nomeInfoTrigger');
        const nomeInfoModal = document.getElementById('nomeInfoModal');
        const closeNomeInfoModal = document.getElementById('closeNomeInfoModal');

        if (nomeInfoTrigger && nomeInfoModal && closeNomeInfoModal) { // Verifica se os elementos existem
            nomeInfoTrigger.addEventListener('click', (event) => {
                event.stopPropagation(); // Impede que o clique no trigger feche o modal imediatamente se o modal já estiver aberto e for clicado (no caso do listener global)
                nomeInfoModal.style.display = 'block';
            });

            closeNomeInfoModal.addEventListener('click', () => {
                nomeInfoModal.style.display = 'none';
            });

            // Fechar o modal de informação do nome se clicar fora do seu conteúdo
            window.addEventListener('click', (event) => {
                if (event.target == nomeInfoModal) { // Se o clique foi no fundo (overlay) do modal
                    nomeInfoModal.style.display = 'none';
                }
            });
        } else {
            console.warn("Elementos do modal de informação do nome (nomeInfoTrigger, nomeInfoModal ou closeNomeInfoModal) não encontrados.");
        }

        // Função para validar se o valor do input está na datalist
        function isValidDatalistValue(inputId, datalistId) {
            const inputElement = document.getElementById(inputId);
            const datalist = document.getElementById(datalistId);
            if (!inputElement || !datalist) {
                console.error("Input ou Datalist não encontrado para validação:", inputId, datalistId);
                return false; 
            }
            const inputValue = inputElement.value.trim();
            // Campos no formulário são obrigatórios, então não podem estar vazios.
            if (inputValue === "") return false; 

            for (let i = 0; i < datalist.options.length; i++) {
                if (datalist.options[i].value === inputValue) {
                    return true;
                }
            }
            return false;
        }
    </script>
</body>
</html>