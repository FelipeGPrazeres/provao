<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enviar Dados</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <header class="top-nav">
        <div class="nav-inner">
            <div class="nav-left">
                <h1>MEUPROVAO<span class="dot">.</span></h1>
            </div>
        </div>
    </header>

    <div class="main-container">
        <div class="form-container">
            <h2>Enviar Novos Dados</h2>
            <form id="dataForm">
                <div class="input-group">
                    <label for="campo1">Nome:</label>
                    <input type="text" id="campo1" placeholder="Digite seu nome completo" required>
                </div>

                <div class="input-group">
                    <label for="campo2">Tipo de Cota:</label>
                    <select id="campo2" required>
                        <option value="">Selecione uma opção</option>
                        <option value="L1_renda">L1 (renda)</option>
                        <option value="L2_renda_ppi">L2 (renda+ppi)</option>
                        <option value="L3_sem_cota">L3 (sem cota)</option>
                        <option value="L4_apenas_ppi">L4 (apenas ppi)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="campo3">Instituição:</label>
                    <input type="text" id="campo3" list="institutionsList" placeholder="Digite ou selecione a Instituição" required>
                    <datalist id="institutionsList"></datalist>
                </div>

                <div class="input-group">
                    <label for="campo4">Curso:</label>
                    <input type="text" id="campo4" list="coursesList" placeholder="Digite ou selecione o Curso" required>
                    <datalist id="coursesList"></datalist>
                </div>

                <div class="input-group">
                    <label for="campoUnicoNumero">Seu Número:</label>
                    <input type="number" id="campoUnicoNumero" placeholder="Digite seu número" required>
                </div>
                
                <button type="submit">Enviar Dados</button>
            </form>
            <p id="formMessage"></p>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-inner">
            <h3>Grupo de Apoio para Vestibulandos 2025</h3>
            <p>Entre no grupo do WhatsApp e tire suas dúvidas com outros candidatos!</p>
            <a class="group-link" href="https://chat.whatsapp.com/EP0btFILC5s38znclDM3pO" target="_blank">Entrar no Grupo</a>
            <h3>Contato</h3>
            <div class="contact-container">
                <div class="contact-box">
                    <p><strong>Kauan Yuri</strong></p>
                    <p>WhatsApp:
                        <a href="https://wa.me/5516994297281" target="_blank">16 99429-7281</a>
                    </p>
                    <p>Instagram:
                        <a href="https://www.instagram.com/dev.kauan" target="_blank">@dev.kauan</a>
                    </p>
                </div>
                <div class="contact-box">
                    <p><strong>Felipe Galvão</strong></p>
                    <p>WhatsApp:
                        <a href="https://wa.instagram.com/felipe.prazeresz" target="_blank">16 99214-5809</a>
                    </p>
                    <p>Instagram:
                        <a href="https://www.instagram.com/felipe.prazeresz" target="_blank">@felipe.prazeresz</a>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        const SUPABASE_URL = 'https://iradczvlimgyukwbwqcl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlyYWRjenZsaW1neXVrd2J3cWNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxMTQwMDcsImV4cCI6MjA2MzY5MDAwN30.CcLvcjhUaNvgSEHFunka_Er-RQ8iwMKInP5lvIrlqIY';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const campo3Input = document.getElementById('campo3');
        const campo4Input = document.getElementById('campo4');
        const institutionsList = document.getElementById('institutionsList');
        const coursesList = document.getElementById('coursesList');
        const formMessage = document.getElementById('formMessage');

        let allAvailableInstitutions = [];
        let allAvailableCourses = [];

        async function loadFilterData() {
            try {
                const categoriesResponse = await fetch('https://provao.onrender.com/categories');
                const categories = await categoriesResponse.json();

                if (categories.length > 0) {
                    const defaultCategory = categories[0];

                    const institutionsResponse = await fetch(`https://provao.onrender.com/institutions?category=${defaultCategory}`);
                    allAvailableInstitutions = await institutionsResponse.json();

                    const coursesResponse = await fetch(`https://provao.onrender.com/courses?category=${defaultCategory}`);
                    allAvailableCourses = await coursesResponse.json();

                    console.log('Dados de filtro carregados para a categoria:', defaultCategory);
                } else {
                    console.warn('Nenhuma categoria encontrada para carregar os filtros.');
                }
            } catch (error) {
                console.error('Erro ao carregar dados para os filtros:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', loadFilterData);

        campo3Input.addEventListener('input', () => {
            const currentInput = campo3Input.value.toLowerCase();
            institutionsList.innerHTML = '';

            if (currentInput.length >= 2) {
                const filteredInstitutions = allAvailableInstitutions.filter(institution =>
                    institution.toLowerCase().includes(currentInput)
                );

                filteredInstitutions.forEach(institution => {
                    let option = document.createElement('option');
                    option.value = institution;
                    institutionsList.appendChild(option);
                });
            }
        });

        campo4Input.addEventListener('input', () => {
            const currentInput = campo4Input.value.toLowerCase();
            coursesList.innerHTML = '';

            if (currentInput.length >= 2) {
                const filteredCourses = allAvailableCourses.filter(course =>
                    course.toLowerCase().includes(currentInput)
                );

                filteredCourses.forEach(course => {
                    let option = document.createElement('option');
                    option.value = course;
                    coursesList.appendChild(option);
                });
            }
        });

        document.getElementById('dataForm').addEventListener('submit', async function(event) {
            console.log('Form submission initiated.');
            event.preventDefault(); 
            console.log('Default form submission prevented.');

            const campo1 = document.getElementById('campo1').value;
            const campo2 = document.getElementById('campo2').value;
            const campo3 = document.getElementById('campo3').value;
            const campo4 = document.getElementById('campo4').value;
            const campoUnicoNumero = parseFloat(document.getElementById('campoUnicoNumero').value);

            console.log('Data collected:', { campo1, campo2, campo3, campo4, campoUnicoNumero });

            if (!campo2) {
                formMessage.textContent = 'Por favor, selecione uma opção para o Tipo de Cota.';
                formMessage.style.color = 'red';
                return;
            }

            console.log('Attempting to send data to Supabase...');
            try {
                const { data, error } = await supabaseClient
                    .from('dados_formulario') // Substitua pelo nome da sua tabela no Supabase
                    .insert([
                        { 
                            campo1: campo1, 
                            tipo_cota: campo2,
                            instituicao: campo3,
                            curso: campo4,
                            numero_unico: campoUnicoNumero // Novo nome da coluna para o campo numérico
                        }
                    ]);

                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }

                console.log('Data sent successfully to Supabase:', data);
                formMessage.textContent = 'Dados enviados com sucesso!';
                formMessage.style.color = 'green';
                this.reset();
                institutionsList.innerHTML = '';
                coursesList.innerHTML = '';
            } catch (error) {
                console.error('Erro ao enviar dados:', error.message);
                formMessage.textContent = 'Erro ao enviar dados: ' + error.message;
                formMessage.style.color = 'red';
            }
        });
    </script>
</body>
</html>