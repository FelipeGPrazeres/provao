<!DOCTYPE html>
<html lang="pt-br">
<head>
    <link rel="stylesheet" href="styles.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Busca por Curso</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .container { width: 80%; margin: 0 auto; padding-top: 20px; }
        #categorySelect { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; }
        #institutionInput { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; }
        #courseInput { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; }
        #searchButton { padding: 10px 20px; cursor: pointer; }
        #results { margin-top: 20px; border: 1px solid #eee; padding: 10px; }
        .person { margin-bottom: 10px; padding: 10px; border-bottom: 1px dashed #ddd; }
        .person:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Buscar Alunos por Curso e Instituição</h1>

        <label for="categorySelect">Selecione a Categoria:</label>
        <select id="categorySelect">
            <option value="">Selecione uma categoria</option>
            <!-- Categories will be loaded here -->
        </select>

        <label for="institutionInput">Filtrar por Instituição (opcional):</label>
        <input type="text" id="institutionInput" list="institutionsList" placeholder="Digite o nome da Instituição (opcional)">
        <datalist id="institutionsList"></datalist>

        <label for="courseInput">Selecione ou digite o curso:</label>
        <input type="text" id="courseInput" list="coursesList" placeholder="Digite o nome do curso" disabled>
        <datalist id="coursesList"></datalist>

        <button id="searchButton" disabled>Buscar</button>

        <div id="results">
            <h2>Resultados:</h2>
            <div id="peopleList">
                <!-- Resultados da busca aparecerão aqui -->
            </div>
        </div>
    </div>

    <script>
        const categorySelect = document.getElementById('categorySelect');
        const institutionInput = document.getElementById('institutionInput');
        const courseInput = document.getElementById('courseInput');
        const searchButton = document.getElementById('searchButton');
        const resultsDiv = document.getElementById('peopleList');
        const coursesList = document.getElementById('coursesList');
        const institutionsList = document.getElementById('institutionsList');
        let allCourses = {}; // Store courses per category
        let allInstitutions = {}; // Store institutions per category
        let currentCategory = null; // Currently selected category

        // Load categories into the category dropdown
        fetch('https://provao.onrender.com/categories')
            .then(response => response.json())
            .then(categories => {
                categories.forEach(category => {
                    let option = document.createElement('option');
                    option.value = category;
                    option.textContent = category; // Display category name
                    categorySelect.appendChild(option);
                });
            });

        categorySelect.addEventListener('change', () => {
            currentCategory = categorySelect.value;
            courseInput.disabled = false; // Enable course input when category is selected
            searchButton.disabled = false; // Enable search button when category is selected
            courseInput.value = ''; // Clear previous input
            institutionInput.value = ''; // Clear institution input
            coursesList.innerHTML = ''; // Clear previous course suggestions
            institutionsList.innerHTML = ''; // Clear previous institution suggestions

            if (currentCategory) {
                // Fetch courses for the selected category
                fetch(`https://provao.onrender.com/courses?category=${currentCategory}`)
                    .then(response => response.json())
                    .then(courses => {
                        allCourses[currentCategory] = courses; // Store courses for this category
                    });
                // Fetch institutions for the selected category
                fetch(`https://provao.onrender.com/institutions?category=${currentCategory}`)
                    .then(response => response.json())
                    .then(institutions => {
                        allInstitutions[currentCategory] = institutions; // Store institutions for this category
                    });
            } else {
                courseInput.disabled = true;
                searchButton.disabled = true;
            }
        });

        institutionInput.addEventListener('input', () => {
            const currentInput = institutionInput.value;
            institutionsList.innerHTML = ''; // Clear previous institution suggestions

            if (currentInput.length >= 3 && currentCategory) {
                const categoryInstitutions = allInstitutions[currentCategory] || [];
                const filteredInstitutions = categoryInstitutions.filter(institution =>
                    institution.toLowerCase().startsWith(currentInput.toLowerCase())
                );

                filteredInstitutions.forEach(institution => {
                    let option = document.createElement('option');
                    option.value = institution;
                    institutionsList.appendChild(option);
                });
            }
        });


        courseInput.addEventListener('input', () => {
            const currentInput = courseInput.value;
            coursesList.innerHTML = ''; // Clear previous course suggestions

            if (currentInput.length >= 3 && currentCategory) {
                const categoryCourses = allCourses[currentCategory] || [];
                const filteredCourses = categoryCourses.filter(course =>
                    course.toLowerCase().startsWith(currentInput.toLowerCase())
                );

                filteredCourses.forEach(course => {
                    let option = document.createElement('option');
                    option.value = course;
                    coursesList.appendChild(option);
                });
            }
        });


        searchButton.addEventListener('click', () => {
            const selectedCourse = courseInput.value;
            const selectedInstitution = institutionInput.value; // Get institution input value
            if (!selectedCourse) {
                alert("Por favor, digite ou selecione um curso.");
                return;
            }

            if (!currentCategory) {
                alert("Por favor, selecione uma categoria.");
                return;
            }

            const requestBody = { course: selectedCourse, category: currentCategory };
            if (selectedInstitution) { // Add institution to request body if it's not empty
                requestBody.institution = selectedInstitution;
            }

            fetch('https://provao.onrender.com/filter_course', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => response.json())
            .then(people => {
                resultsDiv.innerHTML = ''; // Limpa resultados anteriores
                if (people && people.length > 0) {
                    people.forEach(person => {
                        const personDiv = document.createElement('div');
                        personDiv.classList.add('person');
                        personDiv.innerHTML = `
                            <p><strong>Instituição:</strong> ${person.Institui\u00e7\u00e3o}</p>
                            <p><strong>Curso:</strong> ${person.Curso}</p>
                            <p><strong>Nota:</strong> ${person.Nota}</p>
                            <p><strong>Grupo:</strong> ${person.Grupo}</p>
                        `;
                        resultsDiv.appendChild(personDiv);
                    });
                } else {
                    resultsDiv.innerHTML = '<p>Nenhum aluno encontrado para este curso e instituição nesta categoria.</p>';
                }
            })
            .catch(error => {
                console.error('Erro ao buscar dados:', error);
                resultsDiv.innerHTML = '<p>Erro ao buscar os dados. Tente novamente mais tarde.</p>';
            });
        });
    </script>
</body>
</html>
